name: Deploy to Dev

on:
  push:
    branches:
      - dev

jobs:
  build-and-push-images:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and Push Backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ghcr.io/${{ github.repository_owner }}/blogapp-backend:dev
      - name: Build and Push Frontend
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/.Dockerfile
          push: true
          tags: ghcr.io/${{ github.repository_owner }}/blogapp-frontend:dev
      - name: Scan Backend Image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "ghcr.io/${{ github.repository_owner }}/blogapp-backend:dev"
          format: "table"
          exit-code: "1"
          ignore-unfixed: true
          vuln-type: "os,library"
          severity: "CRITICAL,HIGH"
      - name: Scan Frontend Image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "ghcr.io/${{ github.repository_owner }}/blogapp-frontend:dev"
          format: "table"
          exit-code: "1"
          ignore-unfixed: true
          vuln-type: "library"
          severity: "CRITICAL,HIGH"

  deploy:
    needs: build-and-push-images
    runs-on: self-hosted # ← CRITICAL: must be your on-premise runner
    secrets: inherit # ← CRITICAL: gives the runner all repo secrets
    timeout-minutes: 15 # ← nice to have
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python  Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install Ansible
        run: pip install ansible

      - name: Debug secrets (temporary!)
        run: |
          echo "DEV_SERVER_IP is: '${{ secrets.DEV_SERVER_IP }}'"
          echo "Length: ${#DEV_SERVER_IP}"
          echo "First char: '${{ secrets.DEV_SERVER_IP}}'"

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh/
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.DEV_SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Run Ansible Playbook
        env:
          ANSIBLE_HOST_KEY_CHECKING: "False"
        run: |
          echo "[dev]" > ansible/inventory/hosts
          echo "${{ secrets.DEV_SERVER_IP }} ansible_user=${{ secrets.DEV_SERVER_USER }} ansible_ssh_private_key_file=~/.ssh/id_rsa ansible_ssh_common_args='-o StrictHostKeyChecking=no'" >> ansible/inventory/hosts
          ansible-playbook -i ansible/inventory/hosts ansible/playbook/deploy.yml \
            -e "DEV_SERVER_IP=${{ secrets.DEV_SERVER_IP }}" \
            -e "DEV_SERVER_USER=${{ secrets.DEV_SERVER_USER }}" \
            -e "mysql_root_password=${{ secrets.MYSQL_ROOT_PASSWORD }}" \
            -e "mysql_database=${{ secrets.MYSQL_DATABASE }}" \
            -e "mysql_user=${{ secrets.MYSQL_USER }}" \
            -e "mysql_password=${{ secrets.MYSQL_PASSWORD }}" \
            -e "secret_key=${{ secrets.SECRET_KEY }}" \
            -e "backend_port=${{ vars.BACKEND_PORT || '8000' }}" \
            -e "phpmyadmin_port=${{ vars.PHPMYADMIN_PORT || '8080' }}" \
            -e "github_repository_owner=${{ github.repository_owner }}" \
            -e "github_actor=${{ github.actor }}" \
            -e "github_token=${{ secrets.GITHUB_TOKEN }}"
