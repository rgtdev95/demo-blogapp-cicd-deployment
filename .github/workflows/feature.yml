name: Feature Branch CI/CD

on:
  push:
    branches:
      - "feature/**"
      - "feat/**"

jobs:
  # Run comprehensive CI checks using reusable workflow
  ci-checks:
    name: CI Pipeline
    uses: ./.github/workflows/reusable-ci.yml
    with:
      environment: "feature"
      node-version: "20"
      python-version: "3.11"
    secrets: inherit

  # Build and validate images (no push to registry)
  build-and-validate:
    name: Build & Validate
    needs: ci-checks
    uses: ./.github/workflows/reusable-build.yml
    with:
      environment: "feature"
      push-images: false  # Don't push feature branch images
      backend-size-limit-mb: 500
      frontend-size-limit-mb: 150
    secrets: inherit

  # Feature branch summary
  feature-summary:
    name: Feature Branch Summary
    runs-on: ubuntu-latest
    needs: [ci-checks, build-and-validate]
    if: always()
    steps:
      - name: Feature Branch Validation Results
        run: |
          echo "ğŸ” Feature Branch Validation Complete"
          echo "================================================"
          echo "CI Checks Status: ${{ needs.ci-checks.result }}"
          echo "Build & Validate Status: ${{ needs.build-and-validate.result }}"
          echo ""
          
          if [ "${{ needs.ci-checks.result }}" = "success" ] && [ "${{ needs.build-and-validate.result }}" = "success" ]; then
            echo "âœ… All validations passed! Ready to merge to dev branch."
            echo ""
            echo "ğŸ“Š What was tested:"
            echo "  âœ… Frontend & Backend Linting"
            echo "  âœ… Unit Tests with Coverage"
            echo "  âœ… Security Scans (Dependencies)"
            echo "  âœ… Docker Image Building"
            echo "  âœ… Image Size Validation"
            echo "  â„¹ï¸  Container Vulnerability Scanning (skipped for feature branches)"
            echo ""
            echo "ğŸš€ This feature branch demonstrates:"
            echo "  â€¢ Comprehensive CI/CD pipeline"
            echo "  â€¢ Security-first development approach"
            echo "  â€¢ Automated quality gates"
            echo "  â€¢ Docker best practices"
          else
            echo "âŒ Some validations failed. Please review the results above."
            exit 1
          fi
