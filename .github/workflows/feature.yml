name: Feature Branch CI

on:
  push:
    branches:
      - "feature/**"
      - "feat/**"

jobs:
  # Frontend Linting Job
  frontend-lint:
    name: Frontend Linting
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: "./frontend/package-lock.json"

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

      - name: TypeScript type check
        run: npx tsc --noEmit

  # Backend Linting Job
  backend-lint:
    name: Backend Linting
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"
          cache-dependency-path: "./backend/requirements.txt"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install flake8 black isort mypy

      - name: Run Flake8 (Linting)
        run: flake8 app/ --count --select=E9,F63,F7,F82 --show-source --statistics

      - name: Run Flake8 (Full check with warnings)
        run: flake8 app/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Check code formatting with Black
        run: black --check app/

      - name: Check import sorting with isort
        run: isort --check-only app/

      - name: Run MyPy (Type checking)
        run: mypy app/ --ignore-missing-imports || true

  # Backend Testing Job
  backend-test:
    name: Backend Tests
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"
          cache-dependency-path: "./backend/requirements*.txt"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests with coverage
        env:
          DATABASE_URL: "sqlite+aiosqlite:///:memory:"
          SECRET_KEY: "test_secret_key_for_ci_pipeline"
        run: pytest -v --cov=app --cov-report=term-missing --cov-report=xml

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./backend/coverage.xml

  backend-security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Install dependencies
        run: |
          cd backend
          python -m pip install --upgrade pip
          pip install safety

      - name: Run security check
        run: |
          cd backend
          safety check

  frontend-security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Run security audit
        run: |
          cd frontend
          npm audit --audit-level=high

  # Frontend Testing Job
  frontend-test:
    name: Frontend Tests
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: "./frontend/package-lock.json"

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm run test -- --run

      - name: Generate coverage report
        run: npm run test:coverage -- --run
        if: always()

  # Summary Job
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs:
      [
        frontend-lint,
        backend-lint,
        frontend-test,
        backend-test,
        backend-security,
        frontend-security,
      ]
    if: always()

    steps:
      - name: Check job results
        run: |
          echo "Frontend Lint: ${{ needs.frontend-lint.result }}"
          echo "Backend Lint: ${{ needs.backend-lint.result }}"
          echo "Frontend Test: ${{ needs.frontend-test.result }}"
          echo "Backend Test: ${{ needs.backend-test.result }}"

          if [ "${{ needs.frontend-lint.result }}" != "success" ] || \
             [ "${{ needs.backend-lint.result }}" != "success" ] || \
             [ "${{ needs.frontend-test.result }}" != "success" ] || \
             [ "${{ needs.backend-test.result }}" != "success" ]; then
            echo "❌ One or more checks failed"
            exit 1
          else
            echo "✅ All checks passed"
          fi

  build-images:
    needs: ci-summary
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build Backend Image
        run: docker build -t blogapp-backend:test ./backend

      - name: Build Frontend Image
        run: docker build -f ./frontend/.Dockerfile -t blogapp-frontend:test ./frontend

      - name: Check Image Sizes
        run: |
          # Backend
          BACKEND_BYTES=$(docker image inspect blogapp-backend:test --format='{{.Size}}')
          BACKEND_MB=$(echo "scale=2; $BACKEND_BYTES/1024/1024" | bc)

          echo "Backend Image Size: ${BACKEND_BYTES} bytes (${BACKEND_MB} MB)"

          # Frontend
          FRONTEND_BYTES=$(docker image inspect blogapp-frontend:test --format='{{.Size}}')
          FRONTEND_MB=$(echo "scale=2; $FRONTEND_BYTES/1024/1024" | bc)

          echo "Frontend Image Size: ${FRONTEND_BYTES} bytes (${FRONTEND_MB} MB)"

          # Size limits in MB
          BACKEND_LIMIT_MB=300
          FRONTEND_LIMIT_MB=150

          # Convert MB to bytes for comparison
          BACKEND_LIMIT_BYTES=$((BACKEND_LIMIT_MB * 1024 * 1024))
          FRONTEND_LIMIT_BYTES=$((FRONTEND_LIMIT_MB * 1024 * 1024))

          # Validate
          if [ "$BACKEND_BYTES" -gt "$BACKEND_LIMIT_BYTES" ]; then
            echo "❌ Backend image exceeds ${BACKEND_LIMIT_MB} MB limit"
            exit 1
          fi

          if [ "$FRONTEND_BYTES" -gt "$FRONTEND_LIMIT_BYTES" ]; then
            echo "❌ Frontend image exceeds ${FRONTEND_LIMIT_MB} MB limit"
            exit 1
          fi

      - name: Scan Backend Image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "blogapp-backend:test"
          format: "table"
          exit-code: "1"
          ignore-unfixed: true
          vuln-type: "os,library"
          severity: "CRITICAL,HIGH"

      - name: Scan Frontend Image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "blogapp-frontend:test"
          format: "table"
          exit-code: "1"
          ignore-unfixed: true
          vuln-type: "library" # <---- ignore nginx OS layer
          severity: "CRITICAL,HIGH"
