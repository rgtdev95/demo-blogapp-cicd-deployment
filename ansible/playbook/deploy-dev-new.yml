---
# Simplified Development Deployment using Roles
- name: Deploy Blog App to Development Server
  hosts: dev
  become: true
  vars:
    app_version: "{{ app_version | default('latest') }}"
    target_environment: development

  pre_tasks:
    - name: Display deployment information
      debug:
        msg:
          - "ðŸš€ Starting Development Deployment"
          - "Version: {{ app_version }}"
          - "Target: {{ inventory_hostname }}"
          - "Environment: {{ target_environment }}"
          - "Project Directory: {{ project_dir }}"
          - "Compose File: {{ compose_file }}"

    - name: Verify environment variables are set
      assert:
        that:
          - DEV_SERVER_IP is defined
          - DEV_SERVER_USER is defined
          - mysql_root_password is defined
          - mysql_database is defined
          - mysql_user is defined
          - mysql_password is defined
          - secret_key is defined
          - github_repository_owner is defined
          - github_actor is defined
          - github_token is defined
        fail_msg: "Required environment variables are missing. Check GitHub secrets configuration."

  tasks:
    - name: Setup Docker environment
      include_role:
        name: docker-setup
      tags: docker

    - name: Deploy application
      include_role:
        name: app-deploy
      tags: deploy

    - name: Setup backup (if enabled)
      include_role:
        name: backup
      when: backup_enabled | bool
      tags: backup

    - name: Setup monitoring (if enabled)
      include_role:
        name: monitoring
      when: monitoring_enabled | bool
      tags: monitoring

  post_tasks:
    - name: Display deployment summary
      debug:
        msg:
          - "ðŸŽ‰ Development Deployment Completed Successfully!"
          - "Version: {{ app_version }}"
          - "Environment: {{ target_environment }}"
          - "Frontend: http://{{ DEV_SERVER_IP }}"
          - "Backend: http://{{ DEV_SERVER_IP }}:{{ backend_port }}"
          - "API Docs: http://{{ DEV_SERVER_IP }}:{{ backend_port }}/api/docs"
          - "phpMyAdmin: http://{{ DEV_SERVER_IP }}:{{ phpmyadmin_port }}"
          - "Project Directory: {{ project_dir }}"
          - ""
          - "ðŸ“‹ Next steps:"
          - "1. Test the application endpoints"
          - "2. Check container logs if needed: docker logs <container_name>"
          - "3. Monitor application performance through logs"

  handlers:
    - name: restart containers
      command: docker compose restart
      args:
        chdir: "{{ project_dir }}"
      listen: "restart application"

    - name: reload nginx
      command: docker compose exec nginx nginx -s reload
      args:
        chdir: "{{ project_dir }}"
      ignore_errors: true
      listen: "reload nginx"
