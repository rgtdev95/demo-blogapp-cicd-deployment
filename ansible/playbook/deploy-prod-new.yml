---
# Simplified Production Deployment using Roles
- name: Deploy Blog App to Production Server
  hosts: prod
  become: true
  vars:
    app_version: "{{ app_version | default('latest') }}"
    target_environment: production

  pre_tasks:
    - name: Ensure target environment is production
      fail:
        msg: "This playbook should only be run against production environment"
      when: target_environment != "production"

    - name: Display deployment information
      debug:
        msg:
          - "ðŸš€ Starting Production Deployment"
          - "Version: {{ app_version }}"
          - "Target: {{ inventory_hostname }}"
          - "Environment: {{ target_environment }}"
          - "Domain: {{ domain_name }}"
          - "Project Directory: {{ project_dir }}"
          - "Backup Directory: {{ backup_dir }}"

    - name: Verify production environment variables are set
      assert:
        that:
          - PROD_SERVER_IP is defined
          - PROD_SERVER_USER is defined
          - mysql_root_password is defined
          - mysql_database is defined
          - mysql_user is defined
          - mysql_password is defined
          - secret_key is defined
          - github_repository_owner is defined
          - github_actor is defined
          - github_token is defined
        fail_msg: "Required production environment variables are missing. Check GitHub secrets configuration."

  tasks:
    - name: Create backup of current deployment
      include_role:
        name: backup
      when: backup_enabled | bool
      tags: backup

    - name: Setup Docker environment
      include_role:
        name: docker-setup
      tags: docker

    - name: Deploy application
      include_role:
        name: app-deploy
      tags: deploy

    - name: Setup monitoring stack
      include_role:
        name: monitoring
      when: monitoring_enabled | bool
      tags: monitoring

  post_tasks:
    - name: Display production deployment summary
      debug:
        msg:
          - "ðŸŽ‰ Production Deployment Completed Successfully!"
          - "Version: {{ app_version }}"
          - "Environment: {{ target_environment }}"
          - "Domain: https://{{ domain_name }}"
          - "Backend API: {{ api_url }}/api"
          - "API Documentation: http://{{ PROD_SERVER_IP }}:{{ backend_port }}/api/docs"
          - "phpMyAdmin: http://{{ PROD_SERVER_IP }}:{{ phpmyadmin_port }}"
          - "Project Directory: {{ project_dir }}"
          {% if monitoring_enabled %}
          - ""
          - "ðŸ“Š Monitoring Services:"
          - "Prometheus: http://{{ PROD_SERVER_IP }}:{{ prometheus_port }}"
          - "Grafana: http://{{ PROD_SERVER_IP }}:{{ grafana_port }}"
          - "  Admin User: {{ grafana_admin_user }}"
          - "cAdvisor: http://{{ PROD_SERVER_IP }}:{{ cadvisor_port }}"
          {% endif %}
          {% if backup_enabled %}
          - ""
          - "ðŸ’¾ Backup Information:"
          - "Backup Directory: {{ backup_dir }}"
          - "Retention: {{ backup_retention_days }} days"
          - "Last Backup: {{ backup_timestamp | default('Check deployment-info.json') }}"
          {% endif %}
          - ""
          - "ðŸ“‹ Next steps:"
          - "1. Configure your external reverse proxy to point to this server"
          - "2. Set up SSL certificates in your reverse proxy manager"
          - "3. Test the application through your domain"
          - "4. Configure monitoring alerts (optional)"
          - "5. Set up automated backup scheduling (optional)"

  handlers:
    - name: restart containers
      command: docker compose restart
      args:
        chdir: "{{ project_dir }}"
      listen: "restart application"

    - name: reload nginx
      command: docker compose exec nginx nginx -s reload
      args:
        chdir: "{{ project_dir }}"
      ignore_errors: true
      listen: "reload nginx"

    - name: restart monitoring
      command: docker compose restart prometheus grafana cadvisor
      args:
        chdir: "{{ project_dir }}"
      ignore_errors: true
      when: monitoring_enabled | bool
      listen: "restart monitoring"
