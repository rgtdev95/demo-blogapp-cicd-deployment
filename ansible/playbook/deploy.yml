---
- name: Deploy Blog App to Development Server
  hosts: dev
  become: true
  vars:
    project_dir: /opt/blogapp

  tasks:
    - name: Create Docker network
      community.docker.docker_network:
        name: blogapp_network
        state: present
      register: network_result
      ignore_errors: true

    - name: Create project directory
      file:
        path: "{{ project_dir }}"
        state: directory
        mode: "0755"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    - name: Create Nginx directories
      file:
        path: "{{ project_dir }}/{{ item }}"
        state: directory
        mode: "0755"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
      loop:
        - conf.d
        - logs
        - ssl
        - uploads
        - nginx

    - name: Ensure uploads directory has correct permissions
      file:
        path: "{{ project_dir }}/uploads"
        state: directory
        mode: "0777" # Allow write access for container user (UID 1000)
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"

    - name: Copy Docker Compose file
      copy:
        src: ../../docker-compose.deploy.yml
        dest: "{{ project_dir }}/docker-compose.yml"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0644"

    - name: Copy Nginx configuration
      copy:
        src: ../../docker-apps/nginx/nginx.conf
        dest: "{{ project_dir }}/nginx/nginx.conf"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0644"

    - name: Copy Nginx server configuration
      copy:
        src: ../../docker-apps/nginx/conf.d/docker.conf
        dest: "{{ project_dir }}/conf.d/docker.conf"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0644"

    - name: Create .env file from secrets
      copy:
        dest: "{{ project_dir }}/.env"
        content: |
          # Database Configuration
          MYSQL_ROOT_PASSWORD={{ mysql_root_password }}
          MYSQL_DATABASE={{ mysql_database }}
          MYSQL_USER={{ mysql_user }}
          MYSQL_PASSWORD={{ mysql_password }}
          MYSQL_PORT=3306

          # Backend Configuration
          DATABASE_URL=mysql+aiomysql://{{ mysql_user }}:{{ mysql_password }}@blogapp_mysql:3306/{{ mysql_database }}
          SECRET_KEY={{ secret_key }}
          ALGORITHM=HS256
          ACCESS_TOKEN_EXPIRE_MINUTES=30
          CORS_ORIGINS=http://{{ DEV_SERVER_IP }},http://{{ DEV_SERVER_IP }}:8081,https://dev-blogapp.internal.rtg-homelabs.tech/login
          DEBUG=True
          API_PREFIX=/api
          PORT=8000
          BACKEND_PORT={{ backend_port }}

          # PhpMyAdmin
          PHPMYADMIN_PORT={{ phpmyadmin_port }}

          # Docker
          GITHUB_REPOSITORY_OWNER={{ github_repository_owner }}
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0600"

    - name: Log in to GitHub Container Registry
      community.docker.docker_login:
        registry: ghcr.io
        username: "{{ github_actor }}"
        password: "{{ github_token }}"

    - name: Pull latest images
      command: docker compose pull
      args:
        chdir: "{{ project_dir }}"
    
    - name: Stop existing containers
      command: docker compose down
      args:
        chdir: "{{ project_dir }}"

    - name: Start containers
      command: docker compose up -d --remove-orphans
      args:
        chdir: "{{ project_dir }}"

    - name: Prune unused images
      command: docker image prune -f
