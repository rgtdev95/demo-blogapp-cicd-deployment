---
# Application Deployment Role - Main Tasks

- name: Create project directory
  file:
    path: "{{ project_dir }}"
    state: directory
    mode: "{{ directory_permission }}"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
  tags: directories

- name: Create required subdirectories
  file:
    path: "{{ project_dir }}/{{ item }}"
    state: directory
    mode: "{{ directory_permission }}"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
  loop: "{{ required_directories + (additional_directories | default([])) }}"
  tags: directories

- name: Set special permissions for uploads directory
  file:
    path: "{{ project_dir }}/uploads"
    state: directory
    mode: "{{ uploads_permission }}"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
  tags: directories

- name: Copy Docker Compose file
  copy:
    src: "../../{{ compose_file }}"
    dest: "{{ project_dir }}/docker-compose.yml"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "{{ config_permission }}"
  tags: config

- name: Copy Nginx main configuration
  copy:
    src: "../../docker-apps/nginx/nginx.conf"
    dest: "{{ project_dir }}/nginx/nginx.conf"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "{{ config_permission }}"
  tags: config

- name: Copy Nginx server configuration
  copy:
    src: "../../docker-apps/nginx/conf.d/docker.conf"
    dest: "{{ project_dir }}/conf.d/docker.conf"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "{{ config_permission }}"
  tags: config

- name: Create environment file from template
  template:
    src: env.j2
    dest: "{{ project_dir }}/.env"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "{{ secret_permission }}"
  tags: config

- name: Copy database initialization script (if exists)
  copy:
    src: "../../docker-apps/database/init.sql"
    dest: "{{ project_dir }}/init.sql"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "{{ config_permission }}"
  ignore_errors: true
  tags: config

- name: Start application containers
  command: docker compose up -d --remove-orphans
  args:
    chdir: "{{ project_dir }}"
  register: startup_result
  tags: deploy

- name: Display container startup results
  debug:
    var: startup_result.stdout_lines
  when: startup_result.stdout_lines is defined
  tags: deploy

- name: Wait for database to be healthy
  command: >
    docker exec {{ database_container_name }} mysqladmin ping 
    -h localhost -u {{ mysql_user }} -p{{ mysql_password }}
  register: db_health
  retries: "{{ health_check_retries }}"
  delay: "{{ health_check_delay }}"
  until: db_health.rc == 0
  changed_when: false
  tags: health_check

- name: Wait for backend to be healthy
  uri:
    url: "http://localhost:{{ backend_port }}/health"
    method: GET
    timeout: "{{ health_check_timeout }}"
  register: backend_health
  retries: "{{ health_check_retries }}"
  delay: "{{ health_check_delay }}"
  until: backend_health.status == 200
  changed_when: false
  tags: health_check

- name: Wait for frontend to be healthy
  uri:
    url: "http://localhost/"
    method: GET
    timeout: "{{ health_check_timeout }}"
  register: frontend_health
  retries: "{{ health_check_retries }}"
  delay: "{{ health_check_delay }}"
  until: frontend_health.status == 200
  changed_when: false
  tags: health_check

- name: Get container status
  command: docker ps --format "table {% raw %}{{.Names}}\t{{.Status}}\t{{.Ports}}{% endraw %}"
  register: container_status
  changed_when: false
  tags: verify

- name: Display container status
  debug:
    msg: "{{ container_status.stdout_lines }}"
  tags: verify

- name: Verify deployment endpoints
  uri:
    url: "{{ item.url }}"
    method: GET
    timeout: "{{ health_check_timeout }}"
    status_code: "{{ item.expected_status }}"
  loop:
    - { url: "http://localhost/", expected_status: 200 }
    - { url: "http://localhost:{{ backend_port }}/health", expected_status: 200 }
    - { url: "http://localhost:{{ backend_port }}/api/docs", expected_status: 200 }
  register: endpoint_checks
  ignore_errors: true
  tags: verify

- name: Display endpoint check results
  debug:
    msg: "Endpoint {{ item.item.url }}: {{ 'OK' if item.status == item.item.expected_status else 'FAILED' }}"
  loop: "{{ endpoint_checks.results }}"
  when: endpoint_checks is defined
  tags: verify

- name: Save deployment information
  template:
    src: deployment-info.j2
    dest: "{{ project_dir }}/{{ deployment_info_file }}"
    mode: "{{ config_permission }}"
  when: deployment_info_enabled | bool
  tags: info
