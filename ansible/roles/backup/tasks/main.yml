---
# Backup Role - Production Database and Application Backup

- name: Skip backup tasks for non-production environments
  debug:
    msg: "Skipping backup tasks - not a production environment"
  when: not backup_enabled | bool

- name: Execute backup tasks
  block:
    - name: Create backup directory
      file:
        path: "{{ backup_dir }}"
        state: directory
        mode: "{{ directory_permission }}"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
      tags: backup

    - name: Create timestamped backup directory
      set_fact:
        backup_timestamp: "{{ ansible_date_time.iso8601_basic_short }}"
      tags: backup

    - name: Check if current deployment exists
      stat:
        path: "{{ project_dir }}"
      register: current_deployment
      tags: backup

    - name: Create backup of current deployment
      command: >
        tar {{ backup_compression | ternary('-czf', '-cf') }} 
        {{ backup_dir }}/blogapp-backup-{{ backup_timestamp }}.tar{{ backup_compression | ternary('.gz', '') }} 
        -C {{ project_dir | dirname }} {{ project_dir | basename }}
      when: current_deployment.stat.exists
      register: app_backup_result
      tags: backup

    - name: Display application backup result
      debug:
        msg: "Application backup created: blogapp-backup-{{ backup_timestamp }}.tar{{ backup_compression | ternary('.gz', '') }}"
      when: app_backup_result is defined and app_backup_result.rc == 0
      tags: backup

    - name: Create database backup
      shell: |
        docker exec {{ database_container_name }} mysqldump \
        -u root -p{{ mysql_root_password }} {{ mysql_database }} \
        > {{ backup_dir }}/database-backup-{{ backup_timestamp }}.sql
      when: current_deployment.stat.exists
      register: db_backup_result
      ignore_errors: true
      tags: backup

    - name: Display database backup result
      debug:
        msg: "Database backup {{ 'created successfully' if db_backup_result.rc == 0 else 'failed' }}: database-backup-{{ backup_timestamp }}.sql"
      when: db_backup_result is defined
      tags: backup

    - name: Compress database backup
      command: gzip {{ backup_dir }}/database-backup-{{ backup_timestamp }}.sql
      when: 
        - backup_compression | bool
        - db_backup_result is defined
        - db_backup_result.rc == 0
      ignore_errors: true
      tags: backup

    - name: Find old application backups
      find:
        paths: "{{ backup_dir }}"
        patterns: "blogapp-backup-*.tar*"
        age: "{{ backup_retention_days }}d"
      register: old_app_backups
      tags: cleanup

    - name: Find old database backups
      find:
        paths: "{{ backup_dir }}"
        patterns: "database-backup-*.sql*"
        age: "{{ backup_retention_days }}d"
      register: old_db_backups
      tags: cleanup

    - name: Remove old application backups
      file:
        path: "{{ item.path }}"
        state: absent
      loop: "{{ old_app_backups.files }}"
      when: old_app_backups.files is defined
      tags: cleanup

    - name: Remove old database backups
      file:
        path: "{{ item.path }}"
        state: absent
      loop: "{{ old_db_backups.files }}"
      when: old_db_backups.files is defined
      tags: cleanup

    - name: Display backup retention cleanup
      debug:
        msg: 
          - "Cleaned up {{ old_app_backups.files | length }} old application backups"
          - "Cleaned up {{ old_db_backups.files | length }} old database backups"
          - "Retention policy: {{ backup_retention_days }} days"
      tags: cleanup

    - name: Get backup directory size
      shell: du -sh {{ backup_dir }} | cut -f1
      register: backup_size
      changed_when: false
      tags: info

    - name: Display backup summary
      debug:
        msg:
          - "ðŸ“¦ Backup Summary"
          - "Timestamp: {{ backup_timestamp | default('N/A') }}"
          - "Application backup: {{ 'Created' if app_backup_result is defined and app_backup_result.rc == 0 else 'Skipped/Failed' }}"
          - "Database backup: {{ 'Created' if db_backup_result is defined and db_backup_result.rc == 0 else 'Skipped/Failed' }}"
          - "Backup directory: {{ backup_dir }}"
          - "Total backup size: {{ backup_size.stdout | default('Unknown') }}"
          - "Retention: {{ backup_retention_days }} days"
          - "Compression: {{ backup_compression | ternary('Enabled', 'Disabled') }}"
      tags: info

  when: backup_enabled | bool
